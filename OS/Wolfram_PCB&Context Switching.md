# PCB & Context Switching

> Process Management

CPU에서 프로세스가 여러개 일때, 스케줄링을 통해 관리하는 프로세스를 관리하는 것을 말한다.
이 때, CPU는 각 프로세스들이 누군지 알아야하고 어떠한 상태인지에 대해 알아야만 관리가 가능하다.
그래서 이러한 프로세스들은 Process Metadata를 가지고있다.

### Process Metadata
Process Metadata에는 다음과 같은 정보들이 존재한다.
- Process ID : PID(Process Identification Number) 라고도 한다. : 프로세스 고유 식별 번호
- Process State(프로세스의 상태) : 프로세스의 현재 상태(Ready, Run, Wait 등)를 저장한다.
- Process Priority(스케줄링 정보) : 프로세스 우선순위 같은 스케줄링 관련 정보들을 저장한다.
- CPU Registers : 프로세스의 레지스터 상태를 저장하는 공간 등. CPU내 범용 레지스터, 데이터 레지스터, 세그먼트 레지스터 등이 갖고있는 값을 저장한다.
- Owner(계정 정보) : CPU 사용 시간 정보, 각종 스케줄러에 필요한 정보를 저장
- 기억장치 관리 정보 : 프로그램이 적재될 기억 장치의 상한치, 하한치, 페이지 테이블 등의 정보를 저장한다.
- 입출력 정보 : 프로세스 수행시 필요한 주변 장치, 파일의 정보를 저장한다.
- 프로그램 카운터(PC) : 다음에 실행되는 명령어 주소를 기억시킨다.

이러한 정보들이 담긴 메타데이터는 프로세스가 생성되면 PCB(Process Control Block)에 담기게 된다.

> PCB (Process Controll Block)

- 프로세스의 메타데이터들을 저장해놓는 저장소다. 하나의 PCB안에는 하나의 프로세스의 정보가 담기게 된다.
- 프로그램 실행 -> 프로세스 생성 -> 프로세스 주소공간에 (코드, 데이터, 스택) 생성 -> 프로세스 메타데이터 저장


> PCB는 왜 필요한가?

CPU에서는 프로세스의 상태에 따라 교체 작업이 이루어진다.

한가지 예를 들자면, 인터럽트가 발생하여 할당받아 진행중이던 프로세스가 Block상태가 되고, 인터럽트 프로세스가 Running 상태로 바뀌는 상황에서, 앞으로 다시 수행할 Block 상태의 프로세스의 상태값을 나중을 위해 저장해 두는 것이다.

> PCB 관리 방식

- Linkied List로 관리가 된다.
- PCB List Head에는 PCB들이 생성될 때마다 붙게된다. 주솟값으로 연결이 이루어져 있는 연결 리스트 형태로, 삽입 삭제가 용이하다.
- 프로세스가 생성되면 해당 PCB가 생성되고 프로세스 완료 시 제거가 됩니다.

이런식으로 수행중인 프로세스를 변경할 때, CPU의 레지스터 정보가 변경되는것을 Context Switching이라고 얘기한다.

> Context Switching이 필요한 이유는?

만약 컴퓨터가 매번 한개의 Task를 완전히 처리 해야만 다음 Task를 처리할수 있다고 가정하자.
- 다음 Task를 처리하기 위해 현재 Task 가 끝날때 까지 기다려야한다.
- 당장 급한 Task를 처리할수 없을때가 생긴다.
- 반응 속도가 느려지게되고 사용하기 불편해진다.

이러한 불편한 요소를 개선하기 위해 Context Swtiching이 필요하게 되었다. 장점에 대해 알아보자.
- 컴퓨터 멀티태스킹을 통해 빠른 반응속도를 가지게된다.
- 빠르게 Task를 바꾸면서 실행 하므로 사람입장에서는 실시간으로 처리가 되는것 처럼 보인다.

> Context Switching의 뜻

CPU가 현재 실행하고 있는 TASK의 상태를 저장하고 다음 진행할 TASK의 상태 및 Register값들의 정보를 읽어 새로운 TASK의 Context정보로 교체하는 과정을 말합니다. 다르게 말하면 CPU가 이전의 프로세스 상태를 PCB에 보관하고, 또 다른 프로세스의 정보를 PCB에서 읽어서 레지스터에 적재하는 과정을 말한다. 

또 다르게 말하면 다중 프로그래밍 시스템에서 CPU가 할당되는 프로세스를 변경하기 위해 현재 CPU를 사용하여 실행되고 있는 프로세서 상태 정보를 저장하고 제어권을 인터럽트 서비스 루틴에게 넘기는 작업을 말하기도 한다.

> Context Switching 과정

- TASK에 대부분의 정보는 Register에 저장이 되고 PCB로 관리되어진다.
- 현재 실행하고 있는 TASK의 PCB정보를 저장하게된다.
- 다음 실행할 TASK 의 PCB정보를 읽어 Register에 적재하고 CPU가 이전에 진행했던 과정을 연속으로 실행할수 있도록 한다.

> Context Switching Cost

Context Switching이 발생하면 다음과 같은 Cost가 발생한다.
1. Cache 초기화
2. Memory Mapping 초기화
3. 메모리 접근을 위해 커널은 항상 실행 되어 있어야 한다.

따라서 잦은 Context Swtiching은 컴퓨터 성능 저하를 초래할수 있다.

> Context Switching과 시간할당량

프로세스들의 시간 할당량은 시스템 성능에서 중요한 역할을 한다.
시간 할당량이 적을수록 사용자 입장에서는 여러개의 프로세스가 Concurrency하게 동작하는것같은 느낌을 주지만
인터럽트의 수와 문맥교환 수가 늘어나게된다.
프로세스의 실행을 위한 부가적인 것을 오버헤드(간접 부담 비용) 이라고 하는데, 이 또한 문맥 교환 수와 같이 늘어나게 된다.

- 시간 할당량이 적으면 문맥 교환 수, 인터럽트 횟수, 오버헤드 증가하지만 Concurrency특성을가진다.
- 시간 할당량이 커지면 문맥 교환 수, 인터럽트 횟수, 오버헤드 감소하지만 동시 진행의 느낌을 가지지 못한다



